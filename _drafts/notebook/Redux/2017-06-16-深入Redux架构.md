---
layout: post
title: æ·±å…¥ Redux æ¶æ„
tag: [react, redux]
category: Redux
---
# Redux

ç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçŠ¶æ€

è¿™é‡Œé»˜è®¤å¯¹reduxçš„åŸºç¡€æœ‰æ‰€äº†è§£ï¼Œä¸äº†è§£çš„å¯ä»¥å»[å®˜æ–¹æ–‡æ¡£](http://cn.redux.js.org/)ä¸Šçœ‹çœ‹

Reduxè®¾è®¡ç†å¿µéå¸¸ç²¾ç®€ï¼Œæ²¡æœ‰è¿½æ±‚å¤§è€Œå…¨

æ ¸å¿ƒæµç¨‹å¦‚ä¸‹å›¾ï¼š

![](https://staltz.com/img/flux-unidir-ui-arch.jpg)

å›¾ç‰‡æ¥æºï¼šhttps://staltz.com/img/flux-unidir-ui-arch.jpg




## Redux ä¸‰å¤§åŸåˆ™

- å•ä¸€æ•°æ®æº

    å¯¹äºåºå¤§çš„çŠ¶æ€æ ‘ï¼Œreduxå¼•å…¥combineReduceræ¥è§£å†³

- çŠ¶æ€æ˜¯å¯è¯»çš„

    reduxé€šè¿‡`createStore`ï¼Œæ¥å—çŠ¶æ€å­˜å‚¨æ ‘ï¼Œç„¶åæä¾›äº†`getState`æ¥å£ç”¨äºè·å–çŠ¶æ€æ ‘

- çŠ¶æ€ä¿®æ”¹æ˜¯ç”±çº¯å‡½æ•°å®Œæˆçš„

    > æ¯ä¸€ä¸ªreduceréƒ½æ˜¯çº¯å‡½æ•°ï¼Œæ¥å—ä¸€å®šçš„è¾“å…¥ï¼Œå¿…ä¼šå¾—åˆ°ä¸€å®šçš„è¾“å‡ºã€‚
    
    - æ¯ä¸€æ¬¡reducerçš„ä¿®æ”¹ï¼Œéƒ½ä¸åº”è¯¥åœ¨åŸstateä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„stateå¯¹è±¡ï¼ˆè¿›è¡Œè®¾è®¡åˆ°`imutable`çš„ä½¿ç”¨ï¼‰
    - å¦‚æœstateæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¼šè¿”å›åŸæ¥çš„stateï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„stateå¯¹è±¡

## Redux æºç åˆ†æ

reduxæºç è¿˜æ˜¯æ¯”è¾ƒç®€å•æ˜“æ‡‚çš„ï¼Œè¿™é‡Œåªåˆ—ä¸¾éƒ¨åˆ†

### **reduxæä¾›çš„æ¥å£**

```
export {
  createStore,
  combineReducers,
  bindActionCreators,
  applyMiddleware,
  compose
}
```

- `createStore`

```
function createStore(reducer, preloadedState, enhancer) {
    var currentReducer = reducer
    var currentState = preloadedState  // å­˜å‚¨çŠ¶æ€ï¼Œé€šè¿‡ getState() å¯è·å–
    var currentListeners = []
    var nextListeners = currentListeners
    var isDispatching = false
}
```

### **Reduxæ ¸å¿ƒAPI**

- getState()
- dispatch(action)
- subscribe(listener)

**`dispatch`**

åˆ†å‘ä¸€ä¸ªaction å†…éƒ¨ä¼šæ‰§è¡Œç›¸åº”çš„ reducer(å…¥å‚ï¼šcurrentState, action)ï¼ŒçŠ¶æ€æ›´æ–°ï¼š currentState => nextStateï¼Œå¹¶ä¸”è§¦å‘`subscribe`å›è°ƒçš„æ‰§è¡Œï¼Œé€šå¸¸æ˜¯`rerender`è§†å›¾

```
try {
      isDispatching = true
      currentState = currentReducer(currentState, action)
    } finally {
      isDispatching = false
    }

    var listeners = currentListeners = nextListeners
    for (var i = 0; i < listeners.length; i++) {
      listeners[i](); // æ‰§è¡Œæ¯ä¸€ä¸ªç»‘å®šç›‘å¬äº‹ä»¶
    }
```

**`subscribe`**

æ¥å—ä¸€ä¸ªcallbackï¼Œè®¢é˜…æ¶ˆæ¯ï¼Œæ¯ä¸€æ¬¡dispatchä¹‹åï¼Œstoreå‘ç”Ÿå˜åŒ–ä¼šè°ƒç”¨ï¼ˆğŸ‘† è¯¦çœ‹dispatchçš„å®ç°ï¼Œä¼šè°ƒç”¨å†…éƒ¨çš„listenersï¼‰

```
function subscribe(listener) {

    let isSubscribed = true

    nextListeners.push(listener); // å°†è®¢é˜…ç›‘å¬æ¨å…¥ nextListenersï¼Œç„¶ååœ¨dispatchçš„æ—¶å€™ï¼Œå¯ä»¥æ‰§è¡Œ

  }
```

## Reduxé«˜çº§è¿›é˜¶

- reduxä¸­é—´ä»¶ 
- reduxå¼‚æ­¥æµ

åœ¨æ­¤å¤„ï¼Œæš‚æ—¶ä¸è®¨è®º ğŸ’¨

# React-Redux

`react-redux`æ˜¯åŸºäº**å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶ç›¸åˆ†ç¦»**çš„å¼€å‘æ€æƒ³.

å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç»„ä»¶åŒ–å¼€å‘ä¸­çš„æ™ºèƒ½ç»„ä»¶ä¸æœ¨å¶ç»„ä»¶](https://juejin.im/entry/579ec0efc4c971005ade40ad)

é’ˆå¯¹`react-redux`ä¸»è¦äº†è§£ä»¥ä¸‹ï¼š

- `Provider`
- `mapStateToProps`
- `mapActionToProps`
- `connect`

å…¶ä½™è‡ªè¡Œå»çœ‹æ–‡æ¡£

## Provider

æºç ä¸»è¦å†…å®¹å¾ˆç®€å•ï¼š(åˆ©ç”¨äº†[context](https://facebook.github.io/react/docs/context.html)æ–¹æ³•ï¼Œå¯ä»¥è‡ªåŠ¨çš„å‘å­™å­ç»„ä»¶ä¼ é€’props)

```javascript
export default class Provider extends Component {
  getChildContext() {
    return { store: this.store, storeSubscription: null }
  }

  constructor(props, context) {
    super(props, context)
    this.store = props.store
  }

  render() {
    // DOC:https://facebook.github.io/react/docs/react-api.html#react.children
    return Children.only(this.props.children)
  }
}
```

## Connect

è¿”å›ä¸€ä¸ª`connectHOC`é«˜é˜¶ç»„ä»¶,åŒ…æ‹¬ getChildContextéƒ½æ˜¯åœ¨æ­¤è¿›è¡Œï¼Œæ‰€ä»¥æ¯ä¸ªæœˆconnectçš„ç»„ä»¶ï¼Œéƒ½å¯ä»¥è·å–store

```javascript
export default connectAdvanced((dispatch, options) => (state, props) => ({
    thing: state.things[props.thingId],
    saveThing: fields => dispatch(actionCreators.saveThing(props.thingId, fields)),
}))(YourComponent)
```


## `mapStateToProps` && `mapActionToProps`çš„ä½¿ç”¨

**mapStateToProps** ä½¿ç”¨å…¶ä½¿å¾—UIç»„ä»¶è®¢é˜…Store

```javascript
/**
* @param {} state 
* @param {} ownProps - å®¹å™¨ç»„ä»¶çš„propså¯¹è±¡
* @return {object} - (UI ç»„ä»¶çš„)`props`å’Œï¼ˆå¤–éƒ¨çš„)`state`çš„æ˜ å°„
*/
function mapStateToProps(state,ownProps){
    return {
        [propName]: state[propName]
    }
}

```

**mapDispatchToProps**

mapDispatchToPropsæ˜¯connectå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥å»ºç«‹ UI ç»„ä»¶çš„å‚æ•°åˆ°store.dispatchæ–¹æ³•çš„æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå®šä¹‰äº†å“ªäº›ç”¨æˆ·çš„æ“ä½œåº”è¯¥å½“ä½œ Actionï¼Œä¼ ç»™ Storeã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚
å¦‚æœmapDispatchToPropsæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šå¾—åˆ°dispatchå’ŒownPropsï¼ˆå®¹å™¨ç»„ä»¶çš„propså¯¹è±¡ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚

```javascript
function mapDispatchToProps(dispatch,ownProps){
    return {
        onClick: () =>{
            dispatch()
        }
    }
}
```